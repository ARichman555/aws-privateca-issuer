name: On PR Merged to Main

on:
  pull_request:
    types: [closed]
    branches: [main]

env:
  PROD_REGISTRY: public.ecr.aws/c9o0b7e4
  BETA_REGISTRY: public.ecr.aws/c9o0b7e4
  ECR_USER_AGENT: aws-privateca-issuer
  GO_VERSION: '1.23'

jobs:
  detect-version-bump-label:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      bump_type: ${{ steps.check_labels.outputs.bump_type }}
    steps:
      - name: Check PR labels
        id: check_labels
        run: |
          if ${{ contains(github.event.pull_request.labels.*.name, 'Minor Version') }}; then
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          elif ${{ contains(github.event.pull_request.labels.*.name, 'Patch') }}; then
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          else
            echo "bump_type=none" >> $GITHUB_OUTPUT
            echo "No version bump label found. Skipping version update."
          fi

  determine-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    needs: detect-version-bump-label
    outputs:
      version_to_build: ${{ steps.bump_version.outputs.new_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: get_version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
          echo "Current version: $LATEST_TAG"
          echo "current_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump_version
        run: |
          CURRENT="${{ steps.get_version.outputs.current_version }}"
          BUMP_TYPE="${{ needs.detect-version-bump-label.outputs.bump_type }}"
          
          CURRENT=${CURRENT#v}
          
          IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          
          if [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

  build-beta-ecr:
    needs: determine-version
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Check out code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Setup AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::905418208571:role/GithubActionsPublishRole-wrichman-us-east-1
        aws-region: us-east-1
    - name: Login to Public ECR
      uses: docker/login-action@v3
      with:
        registry: public.ecr.aws
      env:
        AWS_REGION: us-east-1
    - name: Setup Push to ECR
      run: |
        export PLUGIN_VERSION=${{ needs.determine-version.outputs.version_to_build }}
        export TAG_BASE=${{ env.BETA_REGISTRY }}/$(echo ${GITHUB_REPOSITORY,,} | sed s#/#-#)-test
        echo TAG_BASE=$TAG_BASE >> $GITHUB_ENV
        echo PLUGIN_VERSION=$PLUGIN_VERSION >> $GITHUB_ENV
    - name: Build and push container images
      uses: docker/build-push-action@v6
      with:
        build-args: |
          pkg_version=${{ env.PLUGIN_VERSION }}
        context: .
        platforms: linux/amd64,linux/arm64
        tags: |
          ${{ env.TAG_BASE }}:latest
          ${{ env.TAG_BASE }}:${{ env.PLUGIN_VERSION }}
        push: true
        cache-from: type=registry,ref=${{ env.TAG_BASE }}:cache
        cache-to: type=registry,ref=${{ env.TAG_BASE }}:cache,mode=max,image-manifest=true
        provenance: false

  version-validation-beta:
    needs: [detect-version-bump-label, build-beta-ecr, determine-version]
    if: needs.detect-version-bump-label.outputs.bump_type != 'none'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: Validate Beta Image Version
        run: make validate-image-version STAGE=beta VERSION=${{ needs.determine-version.outputs.version_to_build }}

  version-validation-prod:
    needs: [publish-helm-chart, determine-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: Validate Prod Image Version
        run: make validate-image-version STAGE=prod VERSION=${{ needs.determine-version.outputs.version_to_build }}

  run-for-arm-beta:
    needs: [detect-version-bump-label, build-beta-ecr]
    if: needs.detect-version-bump-label.outputs.bump_type != 'none'
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: './.github/workflows/on-safe-to-test-label.yml'
    # with:
    #   architecture: 'arm64'
    #   environment: 'beta'

  run-for-x86-beta:
    needs: [detect-version-bump-label, build-beta-ecr]
    if: needs.detect-version-bump-label.outputs.bump_type != 'none'
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: './.github/workflows/on-safe-to-test-label.yml'
    # with:
    #   architecture: 'x86_64'
    #   environment: 'beta'

  run-helm-tests-beta:
    needs: [detect-version-bump-label, build-beta-ecr]
    if: needs.detect-version-bump-label.outputs.bump_type != 'none'
    uses: ./.github/workflows/helm-test.yml
    with:
      stage: beta

  update-chart:
    needs: [run-for-arm-beta, run-for-x86-beta, run-helm-tests-beta, version-validation-beta, determine-version]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ssh-key: ${{ secrets.DEPLOY_KEY }}
      - name: Modify chart
        run: |
          NEW_VERSION="${{ needs.determine-version.outputs.version_to_build }}"
          sed -i "s/^version: .*/version: ${NEW_VERSION}/" charts/aws-pca-issuer/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: ${NEW_VERSION}/" charts/aws-pca-issuer/Chart.yaml
      - name: Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Update chart version to ${{ needs.determine-version.outputs.version_to_build }}" --signoff
          git push

  build-public-ecr:
    needs: [determine-version, update-chart]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::905418208571:role/GithubActionsPublishRole-wrichman-us-east-1
          aws-region: us-east-1
      - name: Login to Public ECR
        uses: docker/login-action@v3
        with:
          registry: public.ecr.aws
        env:
          AWS_REGION: us-east-1
      - name: Setup Push to Public ECR
        run: |
          export TAG_BASE=${{ env.PROD_REGISTRY }}/$(echo ${GITHUB_REPOSITORY,,} | sed s#/#-#)
          echo TAG_BASE=$TAG_BASE >> $GITHUB_ENV
      - name: Build and push container images
        uses: docker/build-push-action@v6
        with:
          build-args: |
            pkg_version=${{ needs.determine-version.outputs.version_to_build }}
            user_agent=${{ env.ECR_USER_AGENT }}
          context: .
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.TAG_BASE }}:latest
            ${{ env.TAG_BASE }}:${{ needs.determine-version.outputs.version_to_build }}
          push: true
          cache-from: type=registry,ref=${{ env.TAG_BASE }}:cache
          cache-to: type=registry,ref=${{ env.TAG_BASE }}:cache,mode=max,image-manifest=true
          provenance: false

  publish-helm-chart:
    needs: build-public-ecr
    runs-on: ubuntu-latest
    steps:
      - name: Publish Helm chart
        run: |
          echo "Done"

  run-for-arm-prod:
    needs: publish-helm-chart
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: './.github/workflows/on-safe-to-test-label.yml'
    # with:
    #   architecture: 'arm64'
    #   environment: 'prod'

  run-for-x86-prod:
    needs: publish-helm-chart
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: './.github/workflows/on-safe-to-test-label.yml'
    # with:
    #   architecture: 'x86_64'
    #   environment: 'prod'

  run-helm-tests-prod:
    needs: publish-helm-chart
    runs-on: ubuntu-latest
    steps:
      - name: Run
        run: |
          echo "Done"
    # uses: ./.github/workflows/helm-test.yml
    # with:
    #   stage: prod

  release:
    needs: [run-for-arm-prod, run-for-x86-prod, run-helm-tests-prod, version-validation-prod, determine-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine-version.outputs.version_to_build }}
          name: Release ${{ needs.determine-version.outputs.version_to_build }}
          generate_release_notes: true
